
![æ‰‹æ‘¸æ‰‹-100è¡Œä»£ç å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„å›¾ç‰‡æ‡’åŠ è½½](https://user-gold-cdn.xitu.io/2018/1/19/1610db83f9f74712?w=841&h=630&f=jpeg&s=100414)

> æœ¬æ–‡ç›¸å¯¹æ¯”è¾ƒåˆçº§ï¼Œä¸ºäº†èŠ‚çº¦æ—¶é—´ï¼Œè¯·å°ç¥åŠå…¶ä»¥ä¸Šçº§åˆ«çš„åŒå­¦ç›´æ¥å¿½ç•¥ã€‚

æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼šé‚£ä¹ˆå¤šç¬¬ä¸‰æ–¹åº“ï¼Œä¸ºä»€ä¹ˆè¦è‡ªå·±åŠ¨æ‰‹å†™å‘¢ã€‚æ™¯ç§‘åŒå­¦çš„æƒ³æ³•å¾ˆç®€å•ï¼Œå› ä¸ºæœ¬äººç›®å‰è¿˜æ˜¯ä¸€ä¸ªå‰ç«¯å°ç™½ï¼Œåªæœ‰é€šè¿‡ä¸æ–­çš„å†™ï¼Œä¸æ–­çš„å­¦ï¼Œåœ¨ä¸bugçš„ç›¸çˆ±ç›¸æ€ä¸­æ‰èƒ½æ›´å¿«é€Ÿçš„è¿›æ­¥ã€‚åœ¨è¯æ˜å¯è¡Œå¯ç”¨ä¹‹åä¸ä»…å¯ä»¥å‡å°‘é¡¹ç›®çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå³ä¾¿å‡ºç°bugï¼Œè§£å†³è‡ªå·±ä»£ç çš„bugä¹Ÿè¦æ¯”è§£å†³åˆ«äººä»£ç çš„bugè¦å¥½è¿‡ä¸€äº›ã€‚è¯ä¸å¤šè¯´ï¼Œä¸”å…¥æ­£é¢˜ã€‚

#### ä¸€. åŸºç¡€ç»“æ„

> æ‰‹æ‘¸æ‰‹ç¬¬ä¸€æ­¥ã€‚åœ¨ç¬¬ä¸€æ­¥ï¼Œå…ˆæŠŠåŸºç¡€ç»“æ„æ„æ€æ­å»ºä¸€ä¸‹ï¼Œä»¥æ–¹ä¾¿åç»­æ’¸ç ã€‚å›¾ç‰‡æ‡’åŠ è½½æœ¬èº«å°±ä¸æ˜¯ä»€ä¹ˆå¤æ‚çš„å®ç°ï¼Œæ‰€ä»¥åŸºæœ¬ç»“æ„ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ— éå°±æ˜¯åˆå§‹åŒ–ä¸€ä¸‹å‚æ•°ï¼Œå®¹ä¸€ä¸‹é”™ï¼Œç»‘å®šå‡ ä¸ªå‡½æ•°ï¼Œå®ç°ä¸€ä¸‹åŠŸèƒ½è€Œå·²ã€‚å…·ä½“ä»£ç ä¸”å¾€ä¸‹çœ‹ï¼š

```javascript
(function (global, factory) {
    if (typeof exports === 'object' && typeof module !== 'undefined') {
        module.exports = factory(global)
    } else if (typeof define === 'function' && define.amd) {
        define(factory)
    } else {
        global.Lazy = factory(global)
    }
})(this, function () {
    // å…¨å±€å˜é‡ï¼Œæ‰€æœ‰æ–¹æ³•åœ¨æ­¤å¯¹è±¡ä¸Šæ‰©å±•
    var Lazy = {};
    // è®¡æ—¶å™¨
    var timer = null;
    // èŠ‚æµå»¶è¿Ÿæ—¶é—´
    var delay = 150;
    // æ˜¯å¦å¼€å¯èŠ‚æµ
    var debounce = true;
    // æ˜¯å¦å¼€å¯å›¾ç‰‡æ‡’åŠ è½½å›¾ç‰‡çš„é‡è½½ã€‚è§£é‡Šä¸€ä¸‹ï¼šå°±æ˜¯å›¾ç‰‡ç¦»å¼€æ‡’åŠ è½½åŒºåŸŸè¦æŠŠå›¾ç‰‡çŠ¶æ€å¤åŸï¼Œå†æ¬¡è¿›å…¥æ‡’åŠ è½½åŒºåŸŸè¦åœ¨è§†è§‰ä¸Šå‘ˆç°æ‡’åŠ è½½æ•ˆæœ
    // å…ˆå‘µå‘µä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ï¼Œæ­£å¸¸çš„æˆ‘è‚¯å®šæƒ³ä¸åˆ°è¿™ä¹ˆä¸ªæŠ½é£çš„éœ€æ±‚ï¼Œè°è®©æˆ‘æ›¾ç»ç¢°åˆ°è¿‡ä¸€ä¸ªæŠ½é£çš„äº§å“ç»ç†å‘¢ï¼Œå®ç°ä¸éš¾ï¼Œè¿™é‡Œä¹Ÿé¡ºä¾¿å®ç°ä¸€ä¸‹
    var unload = false;
    // å›æ‰å‡½æ•°
    var callback = function () {};
    // å…ƒç´ ç›¸å¯¹äºè§†çª—çš„ä½ç½®é›†åˆ
    var boxRect = {};
    /**
    * åˆ¤æ–­ç›®æ ‡å…ƒç´ æ˜¯å¦å¯è§ #1
    * @param {HTMLElement} element
    * @returns {boolean}
    */
    var isHidden = function (element) {};
    /**
     * åˆ¤æ–­ç›®æ ‡å…ƒç´ æ˜¯å¦è¿›å…¥æ‡’åŠ è½½åŒºåŸŸ #2
     * @param {HTMLElement} element
     * @returns {boolean}
     */
    var canLoadImg = function (element) {};
    /**
     * èŠ‚æµå‡½æ•° #3
     */
    var onDebounceRender = function () {};
    /**
     * å§‹åŒ–æ–¹æ³•ï¼Œå¤–éƒ¨ç›´æ¥è°ƒç”¨ï¼Œé…ç½®å‚æ•°åœ¨æ­¤æ¥æ”¶ #4
     * @param {Object} options
     * @param {String} options.root - å›¾ç‰‡æ»šåŠ¨åŒºåŸŸæ ¹å…ƒç´ é€‰æ‹©å™¨
     * @param {Number} options.offset - æ‡’åŠ è½½é˜ˆå€¼ï¼Œå½“æ²¡æœ‰ã€ä¸Šä¸‹å·¦å³ã€‘4ä¸ªå€¼æ—¶å°†ä»¥æ­¤ä¸ºå‡†
     * @param {Number} options.offsetTop - æ‡’åŠ è½½é˜ˆå€¼ã€ä¸Šã€‘
     * @param {Number} options.offsetRight - æ‡’åŠ è½½é˜ˆå€¼ã€å³ã€‘
     * @param {Number} options.offsetBottom - æ‡’åŠ è½½é˜ˆå€¼ã€ä¸‹ã€‘
     * @param {Number} options.offsetLeft - æ‡’åŠ è½½é˜ˆå€¼ã€å·¦ã€‘
     * @param {Boolean} options.debounce - æ˜¯å¦å¼€å¯å‡½æ•°èŠ‚æµ
     * @param {Number} options.delay - å‡½æ•°èŠ‚æµæ—¶é—´é˜ˆå€¼
     * @param {Boolean} options.unload - å›¾ç‰‡é‡è½½
     * @param {Function} options.callback - æ‡’åŠ è½½æ“ä½œå®Œæˆæ—¶çš„å›æ‰å‡½æ•°
     */
    Lazy.init = function(options) {};
    /**
     * æ‡’åŠ è½½å®ç° #5
     * @param {HTMLElement} element
     */
    Lazy.render = function(element) {};
    /**
     * ä¸æ»¡è¶³æ‡’åŠ è½½æ¡ä»¶æ—¶é”€æ¯ #6
     */
    Lazy.destroy = function() {};
    // è¿”å›
    return Lazy;
});
```

ç”±äºé¡¹ç›®æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œæ‰€ä»¥åŸºç¡€çš„ç»“æ„ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå‰©ä¸‹çš„å‡ æ­¥æˆ‘ä»¬åªéœ€è¦æ‰‹æ‘¸æ‰‹å»åšå¡«ç©ºé¢˜(#1ã€#2ã€#3ã€#4ã€#5ã€#6)å°±å¥½äº†ã€‚so easyï¼Œlet`s goï¼

#### äºŒ. åŠŸèƒ½å‡½æ•°å®ç°

> æ‰‹æ‘¸æ‰‹ç¬¬äºŒæ­¥ã€‚åœ¨ç¬¬äºŒæ­¥æˆ‘ä»¬å…ˆæŠŠ#1ã€#2ã€#3ä¸‰ä¸ªåŠŸèƒ½å‡½æ•°å®ç°ä¸€ä¸‹ã€‚

é¦–å…ˆæ˜¯#1å‡½æ•°`isHidden`çš„å®ç°ã€‚

```javascript
/**
 * åˆ¤æ–­ç›®æ ‡å…ƒç´ æ˜¯å¦å¯è§
 * https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/offsetParent
 * @param {HTMLElement} element
 * @returns {boolean}
 */
var isHidden = function (element) {
    return element.offsetParent === null;
};
```

æ¥ä¸‹æ¥æ˜¯#2å‡½æ•°`canLoadImg`çš„å®ç°ã€‚è¿™å„¿ç”¨åˆ°äº†`Element.getBoundingClientRect()`æ–¹æ³•è¿”å›å…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚å…³äº`Element.getBoundingClientRect()`çš„ä¿¡æ¯è¯·ç‚¹å‡»[ä¼ é€é˜µ](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect)äº†è§£æ›´å¤šã€‚

```javascript
/**
 * åˆ¤æ–­ç›®æ ‡å…ƒç´ æ˜¯å¦è¿›å…¥æ‡’åŠ è½½åŒºåŸŸ
 * æ­¤å‡½æ•°ä¾èµ–isHiddenå‡½æ•°å’ŒboxRectå…¨å±€å˜é‡
 * @param {HTMLElement} element
 * @returns {boolean}
 */
var canLoadImg = function (element) {
    if (isHidden(element)) return false;
    var eleRect = element.getBoundingClientRect();
    return (eleRect.top <= boxRect.b && eleRect.right >= boxRect.l && eleRect.bottom >= boxRect.t && eleRect.left <= boxRect.r);
};
```
æœ€åæ˜¯#3å‡½æ•°`onDebounceRender`çš„å®ç°ã€‚ç”±äºè¿™é‡Œå¯¹èŠ‚æµå‡½æ•°æ²¡ä»€ä¹ˆç‰¹æ®Šéœ€æ±‚ï¼Œæ‰€ä»¥å®ç°çš„æ¯”è¾ƒç®€å•ï¼Œå¦‚æœçœ‹å®˜åŒå­¦éœ€è¦å®Œæ•´çš„debounceå‡½æ•°ï¼Œè¯·ç‚¹å‡»[lodash/debounce.js](https://github.com/lodash/lodash/blob/master/debounce.js)äº†è§£æ›´å¤šã€‚

```javascript
/**
 * èŠ‚æµå‡½æ•°
 * æ­¤å‡½æ•°ä¾èµ–Lazy.renderã€debounceã€timerã€delay
 */
var onDebounceRender = function () {
    if (!debounce) {
        Lazy.render();
    } else {
        clearTimeout(timer);
        timer = setTimeout(function () {
            Lazy.render();
            timer = null;
        }, delay);
    }
};
```
#### ä¸‰. åˆå§‹åŒ–å‡½æ•°

> æ‰‹æ‘¸æ‰‹ç¬¬ä¸‰æ­¥ã€‚æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹`Lazy.init`åˆå§‹åŒ–å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯æ¥æ”¶å‚æ•°ã€ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥æ›´ç®€å•ã€‚

```javascript
/**
 * å§‹åŒ–æ–¹æ³•ï¼Œå¤–éƒ¨ç›´æ¥è°ƒç”¨ï¼Œé…ç½®å‚æ•°åœ¨æ­¤æ¥æ”¶
 * @param {Object} options
 * @param {String} options.root - å›¾ç‰‡æ»šåŠ¨åŒºåŸŸæ ¹å…ƒç´ é€‰æ‹©å™¨
 * @param {Number} options.offset - æ‡’åŠ è½½é˜ˆå€¼ï¼Œå½“æ²¡æœ‰ä¸Šä¸‹å·¦å³æœ‰4ä¸ªå€¼æ—¶å°†ä»¥æ­¤ä¸ºå‡†
 * @param {Number} options.offsetTop - æ‡’åŠ è½½é˜ˆå€¼ã€ä¸Šã€‘
 * @param {Number} options.offsetRight - æ‡’åŠ è½½é˜ˆå€¼ã€å³ã€‘
 * @param {Number} options.offsetBottom - æ‡’åŠ è½½é˜ˆå€¼ã€ä¸‹ã€‘
 * @param {Number} options.offsetLeft - æ‡’åŠ è½½é˜ˆå€¼ã€å·¦ã€‘
 * @param {Boolean} options.debounce - æ˜¯å¦å¼€å¯å‡½æ•°èŠ‚æµ
 * @param {Number} options.delay - å‡½æ•°èŠ‚æµæ—¶é—´é˜ˆå€¼
 * @param {Boolean} options.unload - å›¾ç‰‡é‡è½½
 * @param {Function} options.callback - æ‡’åŠ è½½æ“ä½œå®Œæˆæ—¶çš„å›æ‰å‡½æ•°
 */
Lazy.init = function (options) {
    options = options || {};
    global = document.querySelector(options.root) || global;
    debounce = options.debounce !== false;
    delay = options.delay || delay;
    unload = options.unload || unload;
    callback = options.callback || callback;
    // æ‡’åŠ è½½åŒºåŸŸï¼Œå†™çš„è™½ç„¶æœ‰ç‚¹é•¿ä½†æ˜¯ä¸éš¾ç†è§£
    boxRect = {
        t: 0 - (options.offsetTop || options.offset || 0),
        r: (global.innerWidth || document.documentElement.clientWidth) + (options.offsetRight || options.offset || 0),
        b: (global.innerHeight || document.documentElement.clientHeight) + (options.offsetBottom || options.offset || 0),
        l: 0 - (options.offsetLeft || options.offset || 0)
    };
    // è¿™é‡Œæå‰è°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºå¦‚æœdebounceä¸ºtrueï¼Œloadä¹‹åä¼šæœ‰æœ€ä½250msçš„å»¶è¿Ÿ
    Lazy.render();
    // ç»‘å®šäº‹ä»¶
    if (global.addEventListener) {
        global.addEventListener('load', onDebounceRender, false);
        global.addEventListener('scroll', onDebounceRender, false);
    } else {
        global.attachEvent('onload', onDebounceRender);
        global.attachEvent('onscroll', onDebounceRender);
    }
};
```
#### å››. æ ¸å¿ƒæ–¹æ³•å®ç°

> æ‰‹æ‘¸æ‰‹ç¬¬å››æ­¥ã€‚åœ¨ç¬¬å››æ­¥æˆ‘ä»¬æ¥å®Œæˆ`Lazy.render`å‡½æ•°çš„å®ç°ã€‚è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ‰€æœ‰çš„æ‡’åŠ è½½å®ç°éƒ½æ˜¯åœ¨æ­¤å¤„å®Œæˆã€‚æ€è·¯ä¸å¤æ‚ï¼Œæ‰€ä»¥å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚

```javascript
/**
 * æ‡’åŠ è½½å®ç°
 * @param {HTMLElement} element
 */
Lazy.render = function (element) {
    // domç»“æ„çº¦å®šï¼šimgæ ‡ç­¾è¦æœ‰[data-lazy]è‡ªå®šä¹‰å±æ€§ï¼Œéœ€è¦è®¾ç½®èƒŒæ™¯çš„æ ‡ç­¾éœ€è¦æœ‰[data-lazy-background]è‡ªå®šä¹‰å±æ€§
    var nodes = (element || document).querySelectorAll('[data-lazy], [data-lazy-background]');
    var len = nodes.length;
    for (var i = 0; i < len; i++) {
        var node = nodes[i];
        // ç›®æ ‡å…ƒç´ åœ¨æ‡’åŠ è½½åŒºåŸŸå’Œä¸åœ¨æ‡’åŠ è½½åŒºåŸŸ
        if (canLoadImg(node)) {
            // æ‡’åŠ è½½å›¾ç‰‡éœ€è¦é‡è½½ï¼Œæ‡’åŠ è½½ä¹‹å‰å…ˆå°†å ä½å›¾ç‰‡å­˜å‚¨
            if (unload && node.src && !node.getAttribute('data-lazy-placeholder')) {
                node.setAttribute('data-lazy-placeholder', node.src);
            }
            // å›¾ç‰‡çš„æ‡’åŠ è½½
            var src = node.getAttribute('data-lazy');
            if (src !== null && node.src !== src) {
                node.src = src;
            }
            // èƒŒæ™¯çš„æ‡’åŠ è½½
            var bgUrl = node.getAttribute('data-lazy-background');
            if (bgUrl !== null && node.style.backgroundImage !== bgUrl) {
                node.style.backgroundImage = 'url(' + bgUrl + ')';
            }
            // å¦‚æœå›¾ç‰‡ä¸éœ€è¦é‡è½½ï¼Œæ‡’åŠ è½½å®Œæˆç§»é™¤[data-lazy]è‡ªå®šä¹‰å±æ€§
            if (!unload) {
                node.removeAttribute('data-lazy');
            }
            // æ‡’åŠ è½½å®Œæˆç§»é™¤[data-lazy-background]è‡ªå®šä¹‰å±æ€§
            node.removeAttribute('data-lazy-background');
            // æ‡’åŠ è½½å®Œæˆè§¦å‘å›æ‰
            callback(node, 'load');
        } else {
            // å½“å›¾ç‰‡ä¸åœ¨æ‡’åŠ è½½åŒºåŸŸæ—¶åšé‡è½½å¤„ç†
            var placeholder = node.getAttribute('data-lazy-placeholder');
            if (unload && placeholder !== null) {
                node.src = placeholder;
                // ç§»é™¤[data-lazy-placeholder]è‡ªå®šä¹‰å±æ€§
                node.removeAttribute('data-lazy-placeholder');
                // é‡è½½å®Œæˆè§¦å‘å›æ‰
                callback(node, 'unload');
            }
        }
    }
    // å¦‚æœæ²¡æœ‰æ‡’åŠ è½½çš„å…ƒç´ ï¼Œé”€æ¯Lazy.initæ·»åŠ çš„äº‹ä»¶
    if (len === 0) {
        Lazy.destroy();
    }
};
```

#### äº”. è§£ç»‘æ–¹æ³•å®ç°

> æ‰‹æ‘¸æ‰‹ç¬¬äº”æ­¥ã€‚è¿™ä¸€æ­¥æ›´ç®€å•ï¼Œè¯ä¸å¤šè¯´ç›´æ¥çœ‹ä»£ç ã€‚

```javascript
/**
 * ä¸æ»¡è¶³æ‡’åŠ è½½æ¡ä»¶æ—¶ç§»é™¤ç»‘å®šçš„äº‹ä»¶ï¼Œé‡ç½®å®šæ—¶å™¨å¼•ç”¨
 */
Lazy.destroy = function () {
    if (document.removeEventListener) {
        global.removeEventListener('scroll', onDebounceRender);
    } else {
        global.detachEvent('onscroll', onDebounceRender);
    }
    clearTimeout(timer);
};
```

#### å…­. ç»“è¯­

ç”±äºæ™¯ç§‘åŒå­¦åˆšå¼€å§‹å†™åšæ–‡ï¼Œè¯­æ–‡è€å¸ˆèµ°çš„åˆæ—©(æ˜¯çœŸçš„æ—©)ğŸ˜‚ï¼Œæ–‡ç¬”éš¾å…æŠ è„šï¼Œä¸è¶³ä¹‹å¤„è¿˜æœ›å„ä½çœ‹å®˜åŒå­¦å¤šå¤šåŒ…å«ã€‚æœ¬é¡¹ç›®æ˜¯æ™¯ç§‘åŒå­¦è‡ªå†™è‡ªæµ‹ï¼Œè™½ç„¶æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¸ä¿è¯æ²¡æœ‰éšè—çš„bugã€‚æ‰€ä»¥å¦‚æœçœ‹å®˜åŒå­¦å‘ç°è¿˜æœ›ç•™è¨€æŒ‡æ­£ï¼Œæ™¯ç§‘åŒå­¦åœ¨æ­¤ä»¥ç¤ºæ„Ÿè°¢ã€‚

æœ¬æ–‡å®Œæ•´ä»£ç [è¯·ç‚¹è¿™é‡Œ](https://github.com/uninge/lazy)ã€‚

> å¦‚æœå¤§ç¥åŒå­¦çœ‹åˆ°æ­¤å¤„ï¼Œæ›´å¸Œæœ›ä½ èƒ½ç•™ä¸‹æ‰¹è¯„æŒ‡æ­£çš„æ„è§ï¼Œè¿™æ ·æ™¯ç§‘åŒå­¦æ‰èƒ½æ›´å¿«çš„è¿›æ­¥ï¼Œä¸‹æ¬¡å¦‚æœä½ ä»¬ä¸å°å¿ƒç‚¹å¼€æ™¯ç§‘åŒå­¦å†™çš„æ–‡ç« æ‰ä¸ä¼šç™½èŠ±èŠ±çš„æµªè´¹å®è´µçš„æ—¶é—´ï¼Œè°è¯´ä¸æ˜¯å‘¢ğŸ˜„ï¼
